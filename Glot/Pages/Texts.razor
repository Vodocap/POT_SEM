@page "/texts"
@using POT_SEM.Core.Models
@using POT_SEM.Core.BridgeAbstractions
@using POT_SEM.Services.Builders
@inject TextProviderBuilder Builder
@inject NavigationManager Navigation

<PageTitle>üåç Multilingual Text Browser</PageTitle>

<h3>üåç Language Learning Texts</h3>

<div class="controls">
    <div class="form-group">
        <label>Language:</label>
        <select @bind="selectedLanguage" class="form-select">
            <option value="en">üá¨üáß English</option>
            <option value="sk">üá∏üá∞ Slovak (Slovenƒçina)</option>
            <option value="ar">üá∏üá¶ Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
            <option value="ja">üáØüáµ Japanese (Êó•Êú¨Ë™û)</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Target Language (for translation):</label>
        <select @bind="targetLanguage" class="form-select">
            <option value="en">üá¨üáß English</option>
            <option value="sk">üá∏üá∞ Slovak</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Difficulty:</label>
        <select @bind="selectedDifficulty" class="form-select">
            <option value="@DifficultyLevel.Beginner">üå± Beginner</option>
            <option value="@DifficultyLevel.Intermediate">üåø Intermediate</option>
            <option value="@DifficultyLevel.Advanced">üå≤ Advanced</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Topic (optional):</label>
        <input type="text" @bind="topic" class="form-control" placeholder="Leave empty for random" />
    </div>
    
    <div class="form-group">
        <label>Count:</label>
        <input type="number" @bind="count" class="form-control" min="1" max="10" />
    </div>
    
    <button @onclick="LoadTexts" class="btn btn-primary" disabled="@isLoading">
        @if (isLoading)
        {
            <span>‚è≥ Loading...</span>
        }
        else
        {
            <span>üîç Load Texts</span>
        }
    </button>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger">
        <strong>‚ùå Error:</strong> @errorMessage
    </div>
}

@if (texts != null && texts.Any())
{
    <div class="texts">
        <p class="info">
            ‚úÖ Found <strong>@texts.Count</strong> text(s) 
            (@GetLanguageName(selectedLanguage) - @selectedDifficulty)
        </p>
        
        @foreach (var text in texts)
        {
            <div class="text-card">
                <h4>@text.Title</h4>
                <div class="meta">
                    <span class="badge bg-info">@text.Difficulty</span>
                    <span class="badge bg-secondary">~@text.Metadata.EstimatedReadingTimeMinutes min</span>
                    <span class="badge bg-light text-dark">@text.Metadata.EstimatedWordCount words</span>
                    <span class="badge bg-success">@text.Metadata.Source</span>
                </div>
                <p class="excerpt">@GetExcerpt(text.Content)</p>
                
                <div class="actions">
                    @if (!string.IsNullOrEmpty(text.Metadata.SourceUrl))
                    {
                        <a href="@text.Metadata.SourceUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                            üìñ Read source ‚Üí
                        </a>
                    }
                    
                    <!-- üî• NEW: Read with translation button -->
                    <button @onclick="() => NavigateToReading(text)" class="btn btn-sm btn-success">
                        üåê Read with translation ‚Üí
                    </button>
                </div>
            </div>
        }
    </div>
}
else if (!isLoading && texts == null)
{
    <div class="alert alert-info">
        ‚ÑπÔ∏è Select language and difficulty, then click "Load Texts"
    </div>
}

@code {
    private string selectedLanguage = "en";
    private string targetLanguage = "sk"; // Default translation target
    private DifficultyLevel selectedDifficulty = DifficultyLevel.Beginner;
    private string? topic;
    private int count = 5;
    
    private bool isLoading = false;
    private string? errorMessage = null;
    private List<POT_SEM.Core.Models.Text>? texts;
    
    private async Task LoadTexts()
    {
        isLoading = true;
        errorMessage = null;
        texts = null;
        
        try
        {
            Console.WriteLine($"üîç Loading {count} {selectedDifficulty} texts in {selectedLanguage}...");
            
            // üî• BRIDGE + BUILDER + STRATEGY PATTERN!
            var provider = Builder
                .ForLanguage(selectedLanguage)
                .ForDifficulty(selectedDifficulty)
                .Build();
            
            texts = await provider.GetTextsAsync(topic: topic, count: count);
            
            Console.WriteLine($"‚úÖ Loaded {texts.Count} texts");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"‚ùå Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    /// <summary>
    /// Navigate to reading page with translation
    /// </summary>
    private void NavigateToReading(POT_SEM.Core.Models.Text text)
    {
        // Encode parameters for URL
        var encodedId = Uri.EscapeDataString(text.Id);
        var sourceLang = text.Language;
        var targetLang = targetLanguage;
        
        // Navigate to: /read/{sourceLang}/{targetLang}/{textId}
        var url = $"/read/{sourceLang}/{targetLang}/{encodedId}";
        
        Console.WriteLine($"üìñ Navigating to reading page: {url}");
        Navigation.NavigateTo(url);
    }
    
    private string GetExcerpt(string content)
    {
        var words = content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Take(40);
        return string.Join(" ", words) + "...";
    }
    
    private string GetLanguageName(string code)
    {
        return TextProviderBuilder.GetLanguageName(code);
    }
}

<style>
    .controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 200px;
    }
    
    .form-select, .form-control {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .form-select:focus, .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    
    .alert-danger {
        background: #fadbd8;
        border-left: 4px solid #e74c3c;
        color: #c0392b;
    }
    
    .alert-info {
        background: #d6eaf8;
        border-left: 4px solid #3498db;
        color: #21618c;
    }
    
    .info {
        background: #d5f4e6;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        border-left: 4px solid #2ecc71;
    }
    
    .texts {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .text-card {
        border: 1px solid #ddd;
        padding: 1.5rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .text-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .text-card h4 {
        margin: 0 0 0.5rem 0;
        color: #2c3e50;
    }
    
    .meta {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .excerpt {
        color: #555;
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    
    .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .badge {
        padding: 0.35rem 0.65rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .bg-info { background-color: #1abc9c; color: white; }
    .bg-secondary { background-color: #95a5a6; color: white; }
    .bg-light { background-color: #ecf0f1; }
    .bg-success { background-color: #2ecc71; color: white; }
    .text-dark { color: #2c3e50; }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .btn-outline-primary {
        background: white;
        color: #3498db;
        border: 2px solid #3498db;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-outline-primary:hover {
        background: #3498db;
        color: white;
    }
</style>