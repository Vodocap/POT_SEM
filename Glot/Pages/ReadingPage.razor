@page "/read/{sourceLang}/{targetLang}/{textId}"
@using POT_SEM.Core.Models
@using POT_SEM.Services.Builders
@using POT_SEM.Services.Processing
@inject TextProviderBuilder Builder
@inject TextProcessingFacade Facade
@inject NavigationManager Navigation

<PageTitle>üìñ Reading: @(_originalText?.Title ?? "Loading...")</PageTitle>

<div class="reading-container">
    <!-- Header -->
    <div class="reading-header">
        <button @onclick="GoBack" class="btn-back">‚Üê Back to Texts</button>
        
        @if (_originalText != null)
        {
            <div class="text-info">
                <h1>@_originalText.Title</h1>
                <div class="meta">
                    <span class="badge">@SourceLang ‚Üí @TargetLang</span>
                    <span class="badge difficulty-@_originalText.Difficulty.ToString().ToLower()">
                        @_originalText.Difficulty
                    </span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="ToggleSentenceTranslations">
                        @(showSentenceTranslations ? "Hide" : "Show") + " sentence translations"
                    </button>
                    @if (_originalText.Metadata?.EstimatedReadingTimeMinutes > 0)
                    {
                        <span class="badge">~@_originalText.Metadata.EstimatedReadingTimeMinutes min</span>
                    }
                </div>
            </div>
        }
    </div>
    
    <!-- Loading State -->
    @if (_isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>‚è≥ Processing text...</p>
            <small>Parsing sentences, translating words...</small>
        </div>
    }
        <!-- Note: Furigana is provided by server-side decorators -->
    
    <!-- Error State -->
    @if (_errorMessage != null)
    {
        <div class="alert alert-danger">
            <strong>‚ùå Error:</strong> @_errorMessage
            <br/>
            <button @onclick="LoadText" class="btn-retry">üîÑ Retry</button>
        </div>
    }
    
    <!-- Reading Content -->
    @if (_processedText != null && !_isLoading)
    {
        <div class="reading-content">
            <div class="stats">
                üìä Stats: 
                <strong>@_processedText.TotalSentences</strong> sentences, 
                <strong>@_processedText.TotalWords</strong> words, 
                <strong>@_processedText.UniqueWords</strong> unique
            </div>
            
            <!-- Sentences -->
            @foreach (var sentence in _processedText.Sentences)
            {
                <div class="sentence" id="sentence-@sentence.Index">
                    <div class="sentence-number">@(sentence.Index + 1)
                        <button class="btn btn-sm btn-link sentence-translate-btn" title="Translate sentence" @onclick="() => TranslateSentenceNow(sentence)" disabled="@IsSentenceLoading(sentence.Index)">
                            @if (IsSentenceLoading(sentence.Index)) {
                                <svg class="icon-spinner" width="12" height="12" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="25" r="20" stroke="#3498db" stroke-width="4" fill="none" stroke-linecap="round"/></svg>
                            } else {
                                <svg class="icon-translate" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#5d6d7e" d="M12 2v2a8 8 0 1 1-8 8H2a10 10 0 1 0 10-10V2z"></path></svg>
                            }
                        </button>
                        @if (sentenceStatus.TryGetValue(sentence.Index, out var st) && !string.IsNullOrEmpty(st))
                        {
                            <svg class="status-icon @GetStatusClass(st)" title="@st" viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="5" r="5"/></svg>
                        }
                    </div>
                    <div class="sentence-content">
                        <!-- Original text with interactive words -->
                        <div class="sentence-text" dir="@GetTextDirection(SourceLang)">
                            @foreach (var word in sentence.Words)
                            {
                                if (word.IsPunctuation)
                                {
                                    <span class="punctuation">@word.Original</span>
                                }
                                else
                                {
                                    var hasFuri = !string.IsNullOrEmpty(word.Furigana) || (word.Metadata.ContainsKey("hasFurigana") && word.Metadata["hasFurigana"] is bool b && b);

                                    if (SourceLang == "ja" && hasFuri)
                                    {
                                        <span class="word-wrapper" title="Click for details">
                                            <ruby>
                                                <span>@word.Original</span>
                                                <rt>@(word.Furigana ?? "")</rt>
                                            </ruby>
                                                    <span class="word-translation">@word.Translation</span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="word-wrapper" title="Click for details">
                                            <span class="word-original">@word.Original</span>
                                            @if (!string.IsNullOrEmpty(word.Translation))
                                            {
                                                <span class="word-translation">@word.Translation</span>
                                            }
                                        </span>
                                    }
                                }
                            }
                        </div>
                        
                        <!-- Sentence translation -->
                            @if (showSentenceTranslations && !string.IsNullOrEmpty(sentence.Translation))
                            {
                                <div class="sentence-translation">
                                    üí¨ @sentence.Translation
                                </div>
                            }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string SourceLang { get; set; } = "en";
    [Parameter] public string TargetLang { get; set; } = "sk";
    [Parameter] public string TextId { get; set; } = "";
    
    private bool _isLoading = true;
    private string? _errorMessage = null;
    private Text? _originalText;
    private ProcessedText? _processedText;
    
    private HashSet<int> _loadingSentences = new();

    private bool IsSentenceLoading(int idx) => _loadingSentences.Contains(idx);

    private async Task TranslateSentenceNow(ProcessedSentence sentence)
    {
        if (sentence == null) return;
        _loadingSentences.Add(sentence.Index);
        StateHasChanged();

        try
        {
            var translated = await Facade.ProcessSentenceAsync(sentence.OriginalText, SourceLang, TargetLang);
            if (translated != null && !string.IsNullOrEmpty(translated.Translation))
            {
                sentence.Translation = translated.Translation;
                sentenceStatus[sentence.Index] = "ok";
                _ = Task.Run(async () => { await Task.Delay(3000); sentenceStatus.Remove(sentence.Index); StateHasChanged(); });
            }
            else
            {
                sentenceStatus[sentence.Index] = "empty";
                _ = Task.Run(async () => { await Task.Delay(3000); sentenceStatus.Remove(sentence.Index); StateHasChanged(); });
            }
        }
        catch (Exception ex)
        {
            sentenceStatus[sentence.Index] = "fail";
            Console.WriteLine($"‚ùå TranslateSentenceNow failed: {ex.Message}");
            _ = Task.Run(async () => { await Task.Delay(3000); sentenceStatus.Remove(sentence.Index); StateHasChanged(); });
        }
        finally
        {
            _loadingSentences.Remove(sentence.Index);
            StateHasChanged();
        }
    }

    private Dictionary<int, string> sentenceStatus = new();
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "ok" => "status-ok",
            "fail" => "status-fail",
            "empty" => "status-empty",
            _ => "status-empty"
        };
    }
    protected override async Task OnInitializedAsync()
    {
        await LoadText();
    }

    private bool showSentenceTranslations = false;

    private void ToggleSentenceTranslations()
    {
        showSentenceTranslations = !showSentenceTranslations;
    }
    
    private async Task LoadText()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            Console.WriteLine($"üìñ Loading text: {TextId} ({SourceLang} ‚Üí {TargetLang})");
            
            // STEP 1: Load original text by TextId (attempt to fetch a batch and find the requested id)
            var difficulty = ParseDifficulty(TextId);
            var provider = Builder.ForLanguage(SourceLang).ForDifficulty(difficulty).Build();

            // Try fetching a larger batch and match by Id or Title
            var texts = await provider.GetTextsAsync(topic: null, count: 20);
            _originalText = texts.FirstOrDefault(t => string.Equals(t.Id, TextId, StringComparison.OrdinalIgnoreCase));

            if (_originalText == null)
            {
                _originalText = texts.FirstOrDefault(t => !string.IsNullOrEmpty(t.Title) && t.Title.Contains(TextId, StringComparison.OrdinalIgnoreCase));
            }

            if (_originalText == null)
            {
                throw new Exception("Text not found");
            }
            
            Console.WriteLine($"‚úÖ Loaded text: '{_originalText.Title}'");
            
            // STEP 2: Process text (FACADE orchestrates: Parse + Translate)
            _processedText = await Facade.ProcessTextAsync(
                _originalText,
                SourceLang,
                TargetLang);

            // Client-side furigana pass for words marked as pending (only in browser)
            if (SourceLang == "ja")
            {
                // Check readiness first
                    // Server-side decorators (FuriganaDecorator + Heuristic fallback) handle furigana for Japanese
            }
            
            Console.WriteLine($"‚úÖ Text processed: {_processedText.TotalSentences} sentences, {_processedText.TotalWords} words");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Console.WriteLine($"‚ùå Error loading text: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private DifficultyLevel ParseDifficulty(string textId)
    {
        // Extract difficulty from textId if it contains it
        // Default to Beginner if not found
        if (textId.Contains("intermediate", StringComparison.OrdinalIgnoreCase))
            return DifficultyLevel.Intermediate;
        if (textId.Contains("advanced", StringComparison.OrdinalIgnoreCase))
            return DifficultyLevel.Advanced;
        
        return DifficultyLevel.Beginner;
    }
    
    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
    
    private string GetTextDirection(string lang)
    {
        return lang == "ar" ? "rtl" : "ltr";
    }

    
}

<style>
    .reading-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .reading-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .text-info h1 {
        margin: 0.5rem 0;
        color: #2c3e50;
        font-size: 2rem;
    }
    
    .meta {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }
    
    .badge {
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .difficulty-beginner {
        background: #27ae60;
    }
    
    .difficulty-intermediate {
        background: #f39c12;
    }
    
    .difficulty-advanced {
        background: #e74c3c;
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
    }
    
    .alert-danger {
        background: #fadbd8;
        border-left: 4px solid #e74c3c;
        color: #c0392b;
    }
    
    .btn-retry {
        margin-top: 0.5rem;
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-retry:hover {
        background: #c0392b;
    }
    
    .stats {
        background: #e8f5e9;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        border-left: 4px solid #4caf50;
        font-size: 0.95rem;
    }
    
    .sentence {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .sentence:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .sentence-number {
        font-weight: bold;
        color: #3498db;
        font-size: 1.2rem;
        min-width: 30px;
    }
    
    .sentence-content {
        flex: 1;
    }
    
    .sentence-text {
        font-size: 1.1rem;
        line-height: 2.2;
        display: inline;
        word-spacing: 0.3rem;
    }
    
    .word-wrapper {
        display: inline-block;
        position: relative;
        cursor: pointer;
        padding: 0.2rem 0.4rem;
        margin: 0.1rem;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        vertical-align: middle;
    }
    
    .word-wrapper:hover {
        background-color: #fff3cd;
    }
    
    .word-original {
        display: inline-block;
        color: #2c3e50;
        font-weight: 500;
    }
    
    /* Word translation tooltip overlay to avoid layout jitter */
    .word-translation {
        position: absolute;
        left: 50%;
        transform: translateX(-50%) translateY(8px);
        white-space: normal;
        max-width: 360px;
        font-size: 0.85rem;
        color: #16a085;
        font-style: italic;
        padding: 6px 8px;
        background: rgba(255,255,255,0.98);
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(17,24,39,0.06);
        opacity: 0;
        visibility: hidden;
        transition: opacity 120ms ease, transform 120ms ease;
        z-index: 40;
        pointer-events: none;
    }

    .word-wrapper:hover .word-translation {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(12px);
        pointer-events: auto;
    }
    
    .punctuation {
        display: inline;
        color: #7f8c8d;
        margin: 0 0.1rem;
    }
    
    .sentence-translation {
        padding: 0.75rem;
        background: #f0f7ff;
        border-left: 3px solid #3498db;
        font-style: italic;
        color: #555;
        margin-top: 1rem;
        border-radius: 4px;
    }
    
    /* RTL support for Arabic */
    [dir="rtl"] {
        text-align: right;
    }
    
    [dir="rtl"] .sentence-text {
        direction: rtl;
    }

.sentence-actions {
    margin-bottom: 0.5rem;
}

.status-badge {
    display: inline-block;
    background: #e8f6ef;
    color: #117a65;
    border: 1px solid #b2dfdb;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-left: 0.5rem;
    font-size: 0.85rem;
}

.sentence-translate-btn {
    border: none;
    padding: 0 4px;
    margin-left: 8px;
    color: #5d6d7e;
    cursor: pointer;
}

.sentence-translate-btn:disabled {
    opacity: 0.6;
    cursor: default;
}

.status-icon {
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin-left:6px;
    vertical-align: middle;
}

/* Hide translate control by default, show on sentence hover */
.sentence-number .sentence-translate-btn { display: none; }
.sentence:hover .sentence-number .sentence-translate-btn { display: inline-block; }

.icon-spinner { animation: spin 1s linear infinite; }
.icon-translate { opacity: 0.9; }

.status-ok { background:#2ecc71; }
.status-fail { background:#e74c3c; }
.status-empty { background:#f1c40f; }
</style>