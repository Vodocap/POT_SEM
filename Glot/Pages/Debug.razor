@page "/debug"
@using POT_SEM.Core.Models
@using POT_SEM.Core.Builders
@using POT_SEM.Core.Interfaces
@using System.Text.Json
@inject TextProviderBuilder Builder
@inject IServiceProvider ServiceProvider

<PageTitle>üß™ Debug Console</PageTitle>

<div class="debug-container">
    <h2>üß™ Pattern Testing Console</h2>
    
    <div class="test-panel">
        <h3>‚öôÔ∏è Test Configuration</h3>
        
        <div class="controls-grid">
            <div class="form-group">
                <label><strong>Language:</strong></label>
                <select @bind="selectedLanguage" class="form-select">
                    <option value="en">üá¨üáß English</option>
                    <option value="ar">üá∏üá¶ Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                    <option value="sk">üá∏üá∞ Slovak (Slovenƒçina)</option>
                    <option value="ru">üá∑üá∫ Russian (–†—É—Å—Å–∫–∏–π)</option>
                    <option value="ja">üáØüáµ Japanese (Êó•Êú¨Ë™û)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label><strong>Difficulty:</strong></label>
                <select @bind="selectedDifficulty" class="form-select">
                    <option value="@DifficultyLevel.Beginner">üå± Beginner</option>
                    <option value="@DifficultyLevel.Intermediate">üåø Intermediate</option>
                    <option value="@DifficultyLevel.Advanced">üå≤ Advanced</option>
                </select>
            </div>
            
            <div class="form-group">
                <label><strong>Topic (optional):</strong></label>
                <input type="text" @bind="topic" class="form-control" placeholder="Leave empty for random" />
            </div>
            
            <div class="form-group">
                <label><strong>Count:</strong></label>
                <input type="number" @bind="count" class="form-control" min="1" max="10" />
            </div>
        </div>
        
        <div class="button-group">
            <button @onclick="TestBuilder" class="btn btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>‚è≥ Testing...</span>
                }
                else
                {
                    <span>üöÄ Run Test</span>
                }
            </button>
            
            <button @onclick="ShowAvailableSources" class="btn btn-info" disabled="@isLoading">
                üìö Show Available Sources
            </button>
            
            <button @onclick="ClearLogs" class="btn btn-secondary">
                üóëÔ∏è Clear Logs
            </button>
        </div>
    </div>
    
    @if (logs.Any())
    {
        <div class="log-panel">
            <h3>üìã Execution Logs</h3>
            <div class="logs">
                @foreach (var log in logs)
                {
                    <div class="log-entry @log.Type">
                        <span class="timestamp">[@log.Timestamp.ToString("HH:mm:ss.fff")]</span>
                        <span class="message">@log.Message</span>
                    </div>
                }
            </div>
        </div>
    }
    
    @if (provider != null)
    {
        <div class="info-panel success">
            <h3>‚úÖ Provider Created</h3>
            <ul>
                <li><strong>Type:</strong> @provider.GetType().Name</li>
                <li><strong>Difficulty:</strong> @provider.DifficultyLevel</li>
                <li><strong>Language Source:</strong> @languageSourceInfo</li>
            </ul>
        </div>
    }
    
    @if (texts != null && texts.Any())
    {
        <div class="results-panel">
            <h3>üìä Results (@texts.Count texts)</h3>
            
            @foreach (var (text, index) in texts.Select((t, i) => (t, i)))
            {
                <div class="text-result">
                    <div class="result-header">
                        <h4>[@(index + 1)] @text.Title</h4>
                        <button @onclick="() => ToggleDetails(index)" class="btn-toggle">
                            @(expandedIndices.Contains(index) ? "‚ñº Hide" : "‚ñ∂ Show") Details
                        </button>
                    </div>
                    
                    <div class="metadata-badges">
                        <span class="badge bg-primary">@text.Language.ToUpper()</span>
                        <span class="badge bg-info">@text.Difficulty</span>
                        <span class="badge bg-secondary">@text.Metadata.EstimatedWordCount words</span>
                        <span class="badge bg-success">~@text.Metadata.EstimatedReadingTimeMinutes min</span>
                        <span class="badge bg-warning text-dark">@text.Metadata.Source</span>
                    </div>
                    
                    <div class="content-preview">
                        <strong>Preview:</strong>
                        <p>@GetPreview(text.Content, 100)</p>
                    </div>
                    
                    @if (expandedIndices.Contains(index))
                    {
                        <div class="details-section">
                            <h5>üìÑ Full Content:</h5>
                            <div class="full-content">@text.Content</div>
                            
                            <h5>üîç Metadata:</h5>
                            <div class="json-viewer">
                                <pre>@JsonSerializer.Serialize(text.Metadata, new JsonSerializerOptions 
                                { 
                                    WriteIndented = true 
                                })</pre>
                            </div>
                            
                            <h5>üìä Analysis:</h5>
                            <ul class="analysis-list">
                                <li><strong>Total Characters:</strong> @text.Content.Length</li>
                                <li><strong>Total Words:</strong> @text.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length</li>
                                <li><strong>Sentences:</strong> @text.Content.Split(new[] {'.', '!', '?'}, StringSplitOptions.RemoveEmptyEntries).Length</li>
                                <li><strong>Avg Sentence Length:</strong> @CalculateAvgSentenceLength(text.Content).ToString("F1") words</li>
                                <li><strong>Fetched At:</strong> @text.FetchedAt.ToString("yyyy-MM-dd HH:mm:ss")</li>
                            </ul>
                            
                            @if (!string.IsNullOrEmpty(text.Metadata.SourceUrl))
                            {
                                <a href="@text.Metadata.SourceUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                    üîó Open Source
                                </a>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
    
    @if (availableSources != null && availableSources.Any())
    {
        <div class="info-panel">
            <h3>üìö Available Language Sources</h3>
            <div class="sources-grid">
                @foreach (var source in availableSources)
                {
                    <div class="source-card">
                        <div class="source-header">
                            <strong>@source.LanguageName</strong>
                            <code>@source.LanguageCode</code>
                        </div>
                        <div class="source-body">
                            <p><strong>Supported Difficulties:</strong></p>
                            <div class="difficulty-badges">
                                @if (source.SupportsDifficulty(DifficultyLevel.Beginner))
                                {
                                    <span class="badge bg-success">Beginner</span>
                                }
                                @if (source.SupportsDifficulty(DifficultyLevel.Intermediate))
                                {
                                    <span class="badge bg-warning text-dark">Intermediate</span>
                                }
                                @if (source.SupportsDifficulty(DifficultyLevel.Advanced))
                                {
                                    <span class="badge bg-danger">Advanced</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    
    @if (errorMessage != null)
    {
        <div class="info-panel error">
            <h3>‚ùå Error</h3>
            <pre>@errorMessage</pre>
        </div>
    }
</div>

@code {
    private string selectedLanguage = "en";
    private DifficultyLevel selectedDifficulty = DifficultyLevel.Beginner;
    private string? topic;
    private int count = 3;
    
    private bool isLoading = false;
    private POT_SEM.Core.BridgeAbstractions.TextProvider? provider;
    private List<Text>? texts;
    private List<ILanguageTextSource>? availableSources;
    private string? languageSourceInfo;
    private string? errorMessage;
    
    private List<LogEntry> logs = new();
    private HashSet<int> expandedIndices = new();
    
    private class LogEntry
    {
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public string Message { get; set; } = "";
        public string Type { get; set; } = "info"; // info, success, warning, error
    }
    
    protected override void OnInitialized()
    {
        AddLog("üéØ Debug Console initialized", "info");
    }
    
    private async Task TestBuilder()
    {
        isLoading = true;
        errorMessage = null;
        texts = null;
        provider = null;
        logs.Clear();
        
        try
        {
            AddLog($"üöÄ Starting test: {selectedLanguage.ToUpper()} - {selectedDifficulty}", "info");
            AddLog($"   Topic: {topic ?? "(random)"}, Count: {count}", "info");
            
            // STEP 1: Build Provider
            AddLog("üì¶ STEP 1: Building TextProvider...", "info");
            AddLog($"   ‚Üí Calling Builder.ForLanguage(\"{selectedLanguage}\")", "info");
            AddLog($"   ‚Üí Calling Builder.ForDifficulty({selectedDifficulty})", "info");
            
            provider = Builder
                .ForLanguage(selectedLanguage)
                .ForDifficulty(selectedDifficulty)
                .Build();
            
            AddLog($"‚úÖ Provider created: {provider.GetType().Name}", "success");
            
            // Get language source info via reflection
            var field = provider.GetType().BaseType?.GetField("_languageSource", 
                System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (field != null)
            {
                var source = field.GetValue(provider) as ILanguageTextSource;
                if (source != null)
                {
                    languageSourceInfo = $"{source.LanguageName} ({source.LanguageCode})";
                    AddLog($"   ‚Üí Language Source: {languageSourceInfo}", "success");
                }
            }
            
            // STEP 2: Fetch Texts
            AddLog("", "info");
            AddLog("üì• STEP 2: Fetching texts...", "info");
            AddLog($"   ‚Üí Calling provider.GetTextsAsync(topic: \"{topic}\", count: {count})", "info");
            
            texts = await provider.GetTextsAsync(topic, count);
            
            if (texts.Any())
            {
                AddLog($"‚úÖ Fetched {texts.Count} text(s)", "success");
                
                foreach (var (text, index) in texts.Select((t, i) => (t, i)))
                {
                    AddLog($"   [{index + 1}] {text.Title}", "info");
                    AddLog($"       Source: {text.Metadata.Source}", "info");
                    AddLog($"       Words: {text.Metadata.EstimatedWordCount}", "info");
                    AddLog($"       Language: {text.Language}", "info");
                }
            }
            else
            {
                AddLog("‚ö†Ô∏è No texts returned", "warning");
            }
            
            AddLog("", "info");
            AddLog("‚úÖ Test completed successfully!", "success");
        }
        catch (Exception ex)
        {
            errorMessage = ex.ToString();
            AddLog($"‚ùå ERROR: {ex.Message}", "error");
            AddLog($"   Stack: {ex.StackTrace}", "error");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task ShowAvailableSources()
    {
        AddLog("üìö Loading available language sources...", "info");
        
        availableSources = ServiceProvider.GetServices<ILanguageTextSource>().ToList();
        
        AddLog($"‚úÖ Found {availableSources.Count} language source(s):", "success");
        
        foreach (var source in availableSources)
        {
            AddLog($"   ‚Ä¢ {source.LanguageName} ({source.LanguageCode})", "info");
            
            var difficulties = new List<string>();
            if (source.SupportsDifficulty(DifficultyLevel.Beginner)) difficulties.Add("Beginner");
            if (source.SupportsDifficulty(DifficultyLevel.Intermediate)) difficulties.Add("Intermediate");
            if (source.SupportsDifficulty(DifficultyLevel.Advanced)) difficulties.Add("Advanced");
            
            AddLog($"     Supports: {string.Join(", ", difficulties)}", "info");
        }
    }
    
    private void ClearLogs()
    {
        logs.Clear();
        AddLog("üßπ Logs cleared", "info");
    }
    
    private void ToggleDetails(int index)
    {
        if (expandedIndices.Contains(index))
        {
            expandedIndices.Remove(index);
        }
        else
        {
            expandedIndices.Add(index);
        }
    }
    
    private void AddLog(string message, string type)
    {
        logs.Add(new LogEntry { Message = message, Type = type });
    }
    
    private string GetPreview(string content, int maxWords)
    {
        var words = content.Split(' ').Take(maxWords);
        return string.Join(" ", words) + (content.Split(' ').Length > maxWords ? "..." : "");
    }
    
    private double CalculateAvgSentenceLength(string content)
    {
        var sentences = content.Split(new[] { '.', '!', '?' }, StringSplitOptions.RemoveEmptyEntries);
        if (sentences.Length == 0) return 0;
        
        var totalWords = sentences.Sum(s => s.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length);
        return (double)totalWords / sentences.Length;
    }
}

<style>
    .debug-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    h2 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 0.5rem;
        margin-bottom: 2rem;
    }
    
    h3 {
        color: #34495e;
        margin-top: 0;
    }
    
    /* Test Panel */
    .test-panel {
        background: white;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-group label {
        font-size: 0.9rem;
        color: #555;
    }
    
    .form-select, .form-control {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
    }
    
    .form-select:focus, .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-info {
        background: #1abc9c;
        color: white;
    }
    
    .btn-info:hover:not(:disabled) {
        background: #16a085;
    }
    
    .btn-secondary {
        background: #95a5a6;
        color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background: #7f8c8d;
    }
    
    /* Log Panel */
    .log-panel {
        background: #2c3e50;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .log-panel h3 {
        color: white;
        margin-bottom: 1rem;
    }
    
    .logs {
        background: #1a252f;
        border-radius: 4px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
    }
    
    .log-entry {
        padding: 0.3rem 0;
        border-bottom: 1px solid #34495e;
    }
    
    .log-entry:last-child {
        border-bottom: none;
    }
    
    .log-entry.info {
        color: #ecf0f1;
    }
    
    .log-entry.success {
        color: #2ecc71;
    }
    
    .log-entry.warning {
        color: #f39c12;
    }
    
    .log-entry.error {
        color: #e74c3c;
    }
    
    .timestamp {
        color: #95a5a6;
        margin-right: 0.5rem;
    }
    
    /* Info Panel */
    .info-panel {
        background: white;
        border-left: 4px solid #3498db;
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .info-panel.success {
        border-left-color: #2ecc71;
        background: #d5f4e6;
    }
    
    .info-panel.error {
        border-left-color: #e74c3c;
        background: #fadbd8;
    }
    
    .info-panel ul {
        margin: 0.5rem 0 0 0;
        padding-left: 1.5rem;
    }
    
    .info-panel li {
        margin: 0.5rem 0;
    }
    
    .info-panel pre {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        margin-top: 1rem;
    }
    
    /* Results Panel */
    .results-panel {
        margin-bottom: 2rem;
    }
    
    .text-result {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .result-header h4 {
        margin: 0;
        color: #2c3e50;
    }
    
    .btn-toggle {
        padding: 0.5rem 1rem;
        background: #ecf0f1;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .btn-toggle:hover {
        background: #bdc3c7;
    }
    
    .metadata-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .badge {
        padding: 0.35rem 0.65rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .bg-primary { background: #3498db; color: white; }
    .bg-info { background: #1abc9c; color: white; }
    .bg-secondary { background: #95a5a6; color: white; }
    .bg-success { background: #2ecc71; color: white; }
    .bg-warning { background: #f39c12; }
    .bg-danger { background: #e74c3c; color: white; }
    .text-dark { color: #2c3e50; }
    
    .content-preview {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    
    .content-preview p {
        margin: 0.5rem 0 0 0;
        color: #555;
        line-height: 1.6;
    }
    
    .details-section {
        border-top: 2px solid #ecf0f1;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .details-section h5 {
        color: #34495e;
        margin: 1rem 0 0.5rem 0;
    }
    
    .full-content {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        line-height: 1.8;
        color: #2c3e50;
        margin-bottom: 1rem;
        white-space: pre-wrap;
    }
    
    .json-viewer {
        background: #1a252f;
        color: #ecf0f1;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        margin-bottom: 1rem;
    }
    
    .json-viewer pre {
        margin: 0;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
    }
    
    .analysis-list {
        background: #f8f9fa;
        padding: 1rem 1rem 1rem 2.5rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    
    .analysis-list li {
        margin: 0.5rem 0;
        color: #555;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .btn-outline-primary {
        background: white;
        color: #3498db;
        border: 2px solid #3498db;
    }
    
    .btn-outline-primary:hover {
        background: #3498db;
        color: white;
    }
    
    /* Sources Grid */
    .sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .source-card {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
    }
    
    .source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ddd;
    }
    
    .source-header code {
        background: #e8eaf6;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .source-body p {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        color: #555;
    }
    
    .difficulty-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
</style>