name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Glot/Glot.csproj
    
    - name: Create dummy Development config
      run: echo '{}' > Glot/wwwroot/appsettings.Development.json
    
    - name: Build
      run: dotnet build Glot/Glot.csproj -c Release --no-restore
    
    - name: Publish
      run: dotnet publish Glot/Glot.csproj -c Release -o release --nologo
    
    - name: Create appsettings.json with Supabase secrets
      run: |
        cat > release/wwwroot/appsettings.json << EOF
        {
          "Supabase": {
            "Url": "${{ secrets.SUPABASE_URL }}",
            "AnonKey": "${{ secrets.SUPABASE_ANON_KEY }}"
          }
        }
        EOF
    
    - name: Change base-tag in index.html
      run: |
        sed -i 's/<base href="\/" \/>/<base href="\/POT_SEM\/" \/>/g' release/wwwroot/index.html
    
    - name: Add .nojekyll file
      run: touch release/wwwroot/.nojekyll
    
    - name: Create smart 404.html with redirect
      run: |
        cat > release/wwwroot/404.html << 'EOFHTML'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="utf-8" />
            <title>Redirecting...</title>
            <script>
              (function() 
              {
                var path = window.location.pathname;
                var base = '/POT_SEM/';
                
                if (path.startsWith(base)) 
                {
                  var route = path.substring(base.length);
                  window.location.replace(base + '?redirect=' + encodeURIComponent(route));
                }
              })();
            </script>
        </head>
        <body>
            <p>‚è≥ Redirecting...</p>
        </body>
        </html>
        EOFHTML
    
    - name: Add redirect handler to index.html
      run: |
        sed -i '/<script src="_framework\/blazor.webassembly.js"><\/script>/i \
        <script>\
          (function() {\
            var redirect = new URLSearchParams(window.location.search).get("redirect");\
            if (redirect) {\
              history.replaceState(null, null, "/POT_SEM/" + redirect);\
            }\
          })();\
        </script>' release/wwwroot/index.html
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: release/wwwroot
        token: ${{ secrets.GITHUB_TOKEN }}
